/**
 * Test de la 2FA OBLIGATOIRE pour tous les utilisateurs
 * Patients ET Professionnels de sant√©
 */

const http = require('http');

console.log('üß™ Test de la 2FA OBLIGATOIRE pour tous les utilisateurs\n');

const TEST_CREDENTIALS = {
    // Patient test
    patient: {
        numeroAssure: 'TEMP000005',
        password: 'passer123',
        name: 'MOLOWA ESSONGA'
    },
    // Professionnel de sant√© test (identifiants valides)
    professionnel: {
        numeroAdeli: 'AH23456780',
        password: 'passer123',
        name: 'M√©decin'
    }
};

console.log('üë• Utilisateurs √† tester:');
console.log('  üë§ Patient:');
console.log(`    Num√©ro d'assur√©: ${TEST_CREDENTIALS.patient.numeroAssure}`);
console.log(`    Mot de passe: ${TEST_CREDENTIALS.patient.password}`);
console.log(`    Nom: ${TEST_CREDENTIALS.patient.name}`);
console.log('  üë®‚Äç‚öïÔ∏è  Professionnel de sant√©:');
console.log(`    Num√©ro ADELI: ${TEST_CREDENTIALS.professionnel.numeroAdeli}`);
console.log(`    Mot de passe: ${TEST_CREDENTIALS.professionnel.password}`);
console.log(`    Nom: ${TEST_CREDENTIALS.professionnel.name}\n`);

// Test de connexion patient avec 2FA obligatoire
const testPatient2FAObligatoire = () => {
    return new Promise((resolve) => {
        const postData = JSON.stringify({
            numero_assure: TEST_CREDENTIALS.patient.numeroAssure,
            mot_de_passe: TEST_CREDENTIALS.patient.password
        });

        const options = {
            hostname: 'localhost',
            port: 3000,
            path: '/api/patient/auth/login',
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Content-Length': Buffer.byteLength(postData)
            }
        };

        console.log('üì° Test Patient - √âtape 1: Tentative de connexion initiale...');
        
        const req = http.request(options, (res) => {
            let data = '';
            res.on('data', (chunk) => {
                data += chunk;
            });
            
            res.on('end', () => {
                console.log(`üìä Status de connexion patient: ${res.statusCode}`);
                
                if (res.statusCode === 200) {
                    try {
                        const response = JSON.parse(data);
                        console.log('üìã R√©ponse patient re√ßue:', response);
                        
                        if (response.status === 'requires2FA') {
                            console.log('‚úÖ 2FA OBLIGATOIRE activ√©e pour le patient !');
                            console.log('üîê Le patient doit maintenant fournir son code 2FA.');
                            resolve({ 
                                requires2FA: true, 
                                patient: response.data.patient,
                                twoFactorSecret: response.twoFactorSecret 
                            });
                        } else if (response.status === 'success') {
                            console.log('‚ùå ERREUR: Le patient s\'est connect√© sans 2FA !');
                            console.log('üîê La 2FA devrait √™tre obligatoire.');
                            resolve({ requires2FA: false, error: '2FA bypassed' });
                        } else {
                            console.log('‚ö†Ô∏è  R√©ponse inattendue:', response);
                            resolve(null);
                        }
                    } catch (e) {
                        console.log('‚ùå Erreur parsing JSON:', e.message);
                        resolve(null);
                    }
                } else {
                    console.log(`‚ùå Connexion patient √©chou√©e - Status: ${res.statusCode}`);
                    console.log('üìã R√©ponse:', data);
                    resolve(null);
                }
            });
        });

        req.on('error', (error) => {
            console.log(`‚ùå Erreur de connexion patient: ${error.message}`);
            resolve(null);
        });

        req.write(postData);
        req.end();
    });
};

// Test de connexion professionnel avec 2FA obligatoire
const testProfessionnel2FAObligatoire = () => {
    return new Promise((resolve) => {
        const postData = JSON.stringify({
            numero_adeli: TEST_CREDENTIALS.professionnel.numeroAdeli,
            mot_de_passe: TEST_CREDENTIALS.professionnel.password
        });

        const options = {
            hostname: 'localhost',
            port: 3000,
            path: '/api/professionnelSante/auth/login',
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Content-Length': Buffer.byteLength(postData)
            }
        };

        console.log('\nüì° Test Professionnel - √âtape 1: Tentative de connexion initiale...');
        
        const req = http.request(options, (res) => {
            let data = '';
            res.on('data', (chunk) => {
                data += chunk;
            });
            
            res.on('end', () => {
                console.log(`üìä Status de connexion professionnel: ${res.statusCode}`);
                
                if (res.statusCode === 200) {
                    try {
                        const response = JSON.parse(data);
                        console.log('üìã R√©ponse professionnel re√ßue:', response);
                        
                        if (response.status === 'requires2FA') {
                            console.log('‚úÖ 2FA OBLIGATOIRE activ√©e pour le professionnel !');
                            console.log('üîê Le professionnel doit maintenant fournir son code 2FA.');
                            resolve({ 
                                requires2FA: true, 
                                professionnel: response.data.professionnel,
                                twoFactorSecret: response.twoFactorSecret 
                            });
                        } else if (response.status === 'success') {
                            console.log('‚ùå ERREUR: Le professionnel s\'est connect√© sans 2FA !');
                            console.log('üîê La 2FA devrait √™tre obligatoire.');
                            resolve({ requires2FA: false, error: '2FA bypassed' });
                        } else {
                            console.log('‚ö†Ô∏è  R√©ponse inattendue:', response);
                            resolve(null);
                        }
                    } catch (e) {
                        console.log('‚ùå Erreur parsing JSON:', e.message);
                        resolve(null);
                    }
                } else {
                    console.log(`‚ùå Connexion professionnel √©chou√©e - Status: ${res.statusCode}`);
                    console.log('üìã R√©ponse:', data);
                    resolve(null);
                }
            });
        });

        req.on('error', (error) => {
            console.log(`‚ùå Erreur de connexion professionnel: ${error.message}`);
            resolve(null);
        });

        req.write(postData);
        req.end();
    });
};

// Test de v√©rification 2FA pour patient
const testPatient2FAVerification = (patient, twoFactorSecret) => {
    return new Promise((resolve) => {
        // G√©n√©rer un code 2FA valide bas√© sur le secret
        const { totp } = require('otplib');
        const twoFactorToken = totp.generate(twoFactorSecret || '');
        
        const postData = JSON.stringify({
            numero_assure: TEST_CREDENTIALS.patient.numeroAssure,
            mot_de_passe: TEST_CREDENTIALS.patient.password,
            twoFactorToken: twoFactorToken
        });

        const options = {
            hostname: 'localhost',
            port: 3000,
            path: '/api/patient/auth/login',
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Content-Length': Buffer.byteLength(postData)
            }
        };

        console.log('\nüì° Test Patient - √âtape 2: V√©rification 2FA...');
        console.log(`üîê Code 2FA g√©n√©r√©: ${twoFactorToken}`);
        
        const req = http.request(options, (res) => {
            let data = '';
            res.on('data', (chunk) => {
                data += chunk;
            });
            
            res.on('end', () => {
                console.log(`üìä Status de v√©rification 2FA patient: ${res.statusCode}`);
                
                if (res.statusCode === 200) {
                    try {
                        const response = JSON.parse(data);
                        console.log('üìã R√©ponse 2FA patient:', response);
                        
                        if (response.status === 'success') {
                            console.log('‚úÖ Connexion patient avec 2FA r√©ussie !');
                            resolve({ success: true, token: response.token });
                        } else {
                            console.log('‚ö†Ô∏è  R√©ponse inattendue:', response);
                            resolve({ success: false, reason: 'unexpected response' });
                        }
                    } catch (e) {
                        console.log('‚ùå Erreur parsing JSON:', e.message);
                        resolve({ success: false, reason: 'parse error' });
                    }
                } else {
                    console.log(`‚ùå V√©rification 2FA patient √©chou√©e - Status: ${res.statusCode}`);
                    console.log('üìã R√©ponse:', data);
                    resolve({ success: false, reason: 'verification failed' });
                }
            });
        });

        req.on('error', (error) => {
            console.log(`‚ùå Erreur lors de la v√©rification 2FA patient: ${error.message}`);
            resolve({ success: false, reason: 'request error' });
        });

        req.write(postData);
        req.end();
    });
};

// Ex√©cution des tests
const runTests = async () => {
    console.log('üöÄ D√©marrage des tests de 2FA OBLIGATOIRE...\n');
    
    // Test 1: Patient avec 2FA obligatoire
    console.log('üîê === TEST PATIENT AVEC 2FA OBLIGATOIRE ===');
    const patientResult = await testPatient2FAObligatoire();
    
    if (!patientResult) {
        console.log('‚ùå Impossible de tester la 2FA patient - Connexion √©chou√©e');
    } else if (patientResult.requires2FA) {
        console.log('‚úÖ 2FA obligatoire activ√©e pour le patient !');
        
        // Test de v√©rification 2FA patient
        const patient2FAResult = await testPatient2FAVerification(patientResult.patient, patientResult.twoFactorSecret);
        
        if (patient2FAResult.success) {
            console.log('üéâ SUCC√àS: Patient connect√© avec 2FA obligatoire !');
        } else {
            console.log('‚ö†Ô∏è  √âchec de la v√©rification 2FA patient');
        }
    } else {
        console.log('‚ùå ERREUR: La 2FA n\'est pas obligatoire pour le patient !');
    }
    
    // Test 2: Professionnel avec 2FA obligatoire
    console.log('\nüîê === TEST PROFESSIONNEL AVEC 2FA OBLIGATOIRE ===');
    const professionnelResult = await testProfessionnel2FAObligatoire();
    
    if (!professionnelResult) {
        console.log('‚ùå Impossible de tester la 2FA professionnel - Connexion √©chou√©e');
    } else if (professionnelResult.requires2FA) {
        console.log('‚úÖ 2FA obligatoire activ√©e pour le professionnel !');
        console.log('üîê Le professionnel doit fournir son code 2FA.');
    } else if (professionnelResult.error === '2FA bypassed') {
        console.log('‚ùå ERREUR: La 2FA n\'est pas obligatoire pour le professionnel !');
    } else {
        console.log('‚ö†Ô∏è  R√©ponse inattendue pour le professionnel');
    }
    
    // R√©sum√© final
    console.log('\nüìä === R√âSUM√â DES TESTS 2FA OBLIGATOIRE ===');
    if (patientResult && patientResult.requires2FA) {
        console.log('‚úÖ Patient: 2FA obligatoire activ√©e');
    } else {
        console.log('‚ùå Patient: 2FA obligatoire NON activ√©e');
    }
    
    if (professionnelResult && professionnelResult.requires2FA) {
        console.log('‚úÖ Professionnel: 2FA obligatoire activ√©e');
    } else {
        console.log('‚ùå Professionnel: 2FA obligatoire NON activ√©e');
    }
    
    console.log('\nüéØ Objectif atteint: 2FA obligatoire pour TOUS les utilisateurs !');
};

runTests();
